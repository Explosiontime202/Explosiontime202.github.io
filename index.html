<!DOCTYPE html><html><head>
      <title>heapheapheap_writeup</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/johannes/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.13/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="writeup-greyctf-2024---heapheapheap">WriteUp GreyCTF 2024 - HeapHeapHeap </h1>
<h2 id="also-known-as-textheap3-or-textpain3">also known as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mtext>Heap</mtext><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">\text{Heap}^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0818em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord text"><span class="mord">Heap</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mtext>Pain</mtext><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">\text{Pain}^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8873em;"></span><span class="mord"><span class="mord text"><span class="mord">Pain</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8873em;"><span style="top:-3.1362em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span> </h2>
<h2 id="what-do-we-have-here">What do we have here? </h2>
<h3 id="heaps">Heaps? </h3>
<p>The program implements a max-heap. For those who don't know what a max-heap is:<br>
Elements (or nodes) are logically ordered in a tree structure where the root node has the highest associated value. In the direction of the leafs, the values decrease monotonic. The tree is usually a binary-tree, so a node can have two children.<br>
When a element is inserted into the heap, it is added as a leaf "somewhere" in the tree. If its value is greater than the value of the parent, the two nodes are swapped. This is repeated until the inserted node has a lower (or equal) value than the parent.<br>
The beforehand mentioned "somewhere" is chosen, such that the tree is balanced. A simple algorithm and more explanation on the balancing is given in <a href="https://stackoverflow.com/a/28397137/11168593">this StackOverflow thread</a>.</p>
<p>The user can modify the max-heap with the following operations:</p>
<ol>
<li>Add node: Add a new node to the heap. The user can provide the value used to order the nodes in the max-heap. Additionally a string of arbitrary length can be stored alongside the value.</li>
<li>Edit root: Edit the root node of the max-heap, i.e. the node with the maximum value. The user can edit both value and the string. The string editing is implemented by freeing the memory and allocating again with a different size.</li>
<li>Delete root: Remove the root node from the heap.</li>
<li>Exit the program.</li>
</ol>
<p>After each operation, the values currently stored in the heap are printed.</p>
<p>The following structs are used in the implementation:</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> value<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>left<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">Heap</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>max<span class="token punctuation">;</span>
    <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-char">char</span> num_nodes<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>The implementation is pointer-based, which means that a node has a pointer to a left child, a right child and to the parent.<br>
If any of the relative nodes do not exists, the pointer is <code>NULL</code>. A node can store a pointer to associated <code>data</code> and also requires to store its associated value.</p>
<p>The heap struct stores the current root node, which is the node with the highest associated value. Also the current number of nodes in the heap is stored which is required for the tree balancing.</p>
<h3 id="heapheaps">HeapHeaps! </h3>
<p>As it would be too boring to only have one heap, the challenge uses a second one to manage node allocations.<br>
The following struct defines the state of the memory allocator:</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">HeapHeap</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Heap</span> heap<span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>memory<span class="token punctuation">;</span>
    <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>top<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> top_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>The heap is used to store free chunks, similar to free lists in common memory allocators, for example ptmalloc. The values stored in the nodes are the sizes of the allocated memory and <code>data</code> points to the beginning of the associated memory.<br>
<code>memory</code> points to the beginning of the entire arena. <code>top</code> and <code>top_size</code> define the top "chunk" which is the point where the wilderness begins and nothing has been allocated yet. (also not to be found in the free <s>list</s> heap).</p>
<p>The memory allocator serves memory from a predefined memory page located in the ELF file. I assume, for simplicity. (thank god, no "real" heap exploitation on modern glibc versions 💀)</p>
<p>The memory allocation is built around the two functions <code>halloc</code> and <code>hfree</code>.</p>
<p>With <code>halloc</code> more memory from the allocator can be requested. It is either served from</p>
<ol>
<li>the root node in the free heap,</li>
<li>the top chunk / wilderness.</li>
</ol>
<p>If there is not enough space in neither of them, the implementation panics.</p>
<p>When the allocation is served from the root of the free heap, but not all of the associated memory is required, the node is split. The remainder is inserted back into the free heap, thus, a new node needs to be created at the start of the remaining memory. The following code is the implementation of that split:</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>old_size <span class="token operator">==</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> node<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>new_node <span class="token operator">=</span> node<span class="token operator">-&gt;</span>data <span class="token operator">+</span> size<span class="token punctuation">;</span>
new_node<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token operator">*</span><span class="token punctuation">)</span>new_node <span class="token operator">+</span> NODE_SIZE<span class="token punctuation">;</span>
new_node<span class="token operator">-&gt;</span>value <span class="token operator">=</span> old_size <span class="token operator">-</span> NODE_SIZE <span class="token operator">-</span> size<span class="token punctuation">;</span>
<span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap_heap<span class="token punctuation">.</span>heap<span class="token punctuation">,</span> new_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>As we can see, there is no check that there is actually enough space for another node after the allocation. This can lead to overlapping chunks. This is the bug which we are gonna exploit and get RCE from.</p>
<p><code>hfree</code> adds the given chunk back to the free heap:</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span> <span class="token function">hfree</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>node <span class="token operator">=</span> ptr <span class="token operator">-</span> NODE_SIZE<span class="token punctuation">;</span>
    <span class="token function">insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>heap_heap<span class="token punctuation">.</span>heap<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="heapheapheap--confused">HeapHeapHeap ?! 😕 </h3>
<p>The binary was compiled with the following security measurements:</p>
<ul>
<li>Partial RELRO</li>
<li>NX</li>
<li>PIE</li>
</ul>
<p>We also can assume that ASLR is active as it is standard on modern GNU/Linux systems.</p>
<p>This means that we can overwrite the GOT and gain control over the control-flow through that. But to forge any pointers, we require the base address of the ELF. Luckily, the heap-based memory allocator contains such pointers because the arena is a page in the image. Therefore, any <code>left</code>, <code>right</code>, <code>parent</code> or <code>data</code> pointer is a image pointer.</p>
<p>Now that we know our target (GOT) and the vulnerability (overlapping chunks), we need to built the hard part of the exploit: The path into the GOT.</p>
<p>I will refer to nodes of <code>heap</code> as "heap nodes" and the nodes in <code>heap_heap.heap</code> as management nodes because they are used for the memory management. As <code>chunks</code> I will refer to the combination of two management nodes, one heap node and one data segment. For example, adding one value-string pair to <code>heap</code> creates one chunk. As length or size of a chunk, I will usually refer to the length of the data segment of this chunk.</p>
<h2 id="how-i-got-there">how I GOT there </h2>
<h3 id="leak-image-base-address-or-why-this-allocator-is-garbage">Leak image base address or why this allocator is garbage </h3>
<p>First of all, we need to trigger the bug and thus create overlapping chunks. In order to do that,</p>
<ol>
<li>we need to be served from the root node of the free heap and</li>
<li>the remaining size must be in the interval <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mtext>sizeof(Node)</mtext><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mtext>x</mtext><mn>28</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0, \text{sizeof(Node)}) = (0, 0\text x28)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">sizeof(Node)</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">28</span><span class="mclose">)</span></span></span></span>.</li>
</ol>
<p>To fulfill the first condition we allocate all the available memory in three chunks:</p>
<ol>
<li>A 0xa00 chunk, value = 1337</li>
<li>A 0x100 chunk, value = 136</li>
<li>The rest (0x398 B), value = 420</li>
</ol>
<p>(Note: all of the values are chosen totally randomly and have no pattern whatsoever, except for their ordering, i.e. value(1. chunk) &gt; value(2. chunk) and so on. This is also true for the rest of the exploit.)</p>
<p>Note that for every of the previously mentioned chunks we also need to account for the space of the two heap allocator management nodes and the one heap node. So we need <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>⋅</mo><mtext>0x28</mtext><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">3 \cdot \text{0x28} + x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">0x28</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> bytes for one of the chunks of size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>.</p>
<p>Now we can use the <code>edit</code> functionality to make the first chunk smaller because the first chunk is the chunk with highest value. We shrink the chunk by 0x20 bytes so that the node describing the rest of the split chunk memory overlaps by 8 bytes with the next node. Moreover, the value (i..e the size) stored for the remainder chunk is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">-8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">8</span></span></span></span> or rather 0xFFFFFFFFFFFFFFF8 as it is a <code>size_t</code>. This means that for now all further allocations are served from that chunk. Note that we need to put null-bytes into the associated string because we require that memory later on to be zero.<br>
Additionally, we reduce the assigned value to 69, so that we can edit the second chunk.</p>
<p>Editing the second chunk with a value of 70 and a new length of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mtext>x</mtext><mn>178</mn><mo>=</mo><mn>0</mn><mtext>x</mtext><mn>28</mn><mo>⋅</mo><mn>3</mn><mo>+</mo><mn>0</mn><mtext>x</mtext><mn>100</mn></mrow><annotation encoding="application/x-tex">0 \text x 178 = 0\text x 28 \cdot 3 + 0\text x 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">178</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">28</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">100</span></span></span></span>. The length is chosen so that the allocated string overlaps all of the chunks previously associated with the second chunk: Two management nodes, a heap node and the previous string. After this allocation, the allocator again puts the chunk describing the rest of the free memory. The new node's <code>data</code> now exactly overlaps with <code>heap.max-&gt;value</code> placing a image pointer into the value.</p>
<p>We cannot write more than 0x10 bytes to the string because we then overwrite the node stored in the heap which will lead to triggering assertions or even segfaults. Luckily, the program allows us to allocate more memory for the string as actually required.</p>
<p>The schematic below shows all the allocated chunks up to this point, but not to scale.<br>
<img src="data:image/svg+xml;charset=utf-8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiID8+CjxzdmcgYmFzZVByb2ZpbGU9ImZ1bGwiIGhlaWdodD0iMzQ1IiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSI4MTkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6ZXY9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEveG1sLWV2ZW50cyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxkZWZzIC8+PHJlY3QgZmlsbD0iI2ZmZmZmZiIgaGVpZ2h0PSIzNDUiIHdpZHRoPSI4MTkiIHg9IjAiIHk9IjAiIC8+PHJlY3QgZmlsbD0iI2ZmZmZmZiIgaGVpZ2h0PSI2NC4wIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSI1MTIiIHg9IjI4MS42IiB5PSIyNS42IiAvPjxyZWN0IGZpbGw9IiNmZmZmZmYiIGhlaWdodD0iNjQuMCIgc3Ryb2tlPSIjMDAwMDAwIiB3aWR0aD0iNTEyIiB4PSIyODEuNiIgeT0iODkuNiIgLz48cmVjdCBmaWxsPSIjMDBmZmZmIiBoZWlnaHQ9IjY0LjAiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjIwLjAiIHg9IjI4MS42IiB5PSIyNS42IiAvPjxyZWN0IGZpbGw9IiNmZjAwZmYiIGhlaWdodD0iNjQuMCIgc3Ryb2tlPSIjMDAwMDAwIiB3aWR0aD0iMjAuMCIgeD0iMzAxLjYiIHk9IjI1LjYiIC8+PHJlY3QgZmlsbD0iIzAwZmZmZiIgaGVpZ2h0PSI2NC4wIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIyMC4wIiB4PSIzMjEuNiIgeT0iMjUuNiIgLz48cmVjdCBmaWxsPSIjZmZhNTAwIiBoZWlnaHQ9IjY0LjAiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjE3OS4wIiB4PSIzNDEuNiIgeT0iMjUuNiIgLz48cmVjdCBmaWxsPSIjMDBmZmZmIiBoZWlnaHQ9IjY0LjAiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjIwLjAiIHg9IjUyMC42IiB5PSIyNS42IiAvPjxyZWN0IGZpbGw9IiNmZjAwZmYiIGhlaWdodD0iNjQuMCIgc3Ryb2tlPSIjMDAwMDAwIiB3aWR0aD0iMjAuMCIgeD0iNTQwLjYiIHk9IjI1LjYiIC8+PHJlY3QgZmlsbD0iIzAwZmZmZiIgaGVpZ2h0PSI2NC4wIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIyMC4wIiB4PSI1NjAuNiIgeT0iMjUuNiIgLz48cmVjdCBmaWxsPSIjZmZhNTAwIiBoZWlnaHQ9IjY0LjAiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjUxLjAiIHg9IjU4MC42IiB5PSIyNS42IiAvPjxyZWN0IGZpbGw9IiMwMGZmZmYiIGhlaWdodD0iNjQuMCIgc3Ryb2tlPSIjMDAwMDAwIiB3aWR0aD0iMjAuMCIgeD0iNjMxLjYiIHk9IjI1LjYiIC8+PHJlY3QgZmlsbD0iI2ZmMDBmZiIgaGVpZ2h0PSI2NC4wIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIyMC4wIiB4PSI2NTEuNiIgeT0iMjUuNiIgLz48cmVjdCBmaWxsPSIjMDBmZmZmIiBoZWlnaHQ9IjY0LjAiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjIwLjAiIHg9IjY3MS42IiB5PSIyNS42IiAvPjxyZWN0IGZpbGw9IiNmZmE1MDAiIGhlaWdodD0iNjQuMCIgc3Ryb2tlPSIjMDAwMDAwIiB3aWR0aD0iMTAyLjAiIHg9IjY5MS42IiB5PSIyNS42IiAvPjxyZWN0IGZpbGw9IiNmZjAwMDAiIGhlaWdodD0iNjQuMCIgc3Ryb2tlPSIjMDAwMDAwIiB3aWR0aD0iMjAuMCIgeD0iNTA4LjYiIHk9Ijg5LjYiIC8+PHJlY3QgZmlsbD0iI2ZmYTUwMCIgaGVpZ2h0PSI2NC4wIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIxMTEuMCIgeD0iNTI4LjYiIHk9Ijg5LjYiIC8+PHJlY3QgZmlsbD0iIzAwZmZmZiIgaGVpZ2h0PSI2NC4wIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIyMC4wIiB4PSI2MzkuNiIgeT0iODkuNiIgLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBzdHlsZT0iZm9udC1zaXplOjI1cHg7IGZvbnQtZmFtaWx5OkFyaWFsIiB4PSIyNS42IiB5PSI3MC40Ij5Jbml0aWFsaXphdGlvbjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBzdHlsZT0iZm9udC1zaXplOjI1cHg7IGZvbnQtZmFtaWx5OkFyaWFsIiB4PSIyNS42IiB5PSIxMzQuNCI+SW1hZ2UgQWRkcmVzcyBMZWFrPC90ZXh0PjxyZWN0IGZpbGw9IiMwMGZmZmYiIGhlaWdodD0iMjEuMzMzMzMzMzMzMzMzMzMyIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIyMS4zMzMzMzMzMzMzMzMzMzIiIHg9IjI4MS42IiB5PSIxNzQuOTMzMzMzMzMzMzMzMzQiIC8+PHRleHQgZmlsbD0iIzAwMDAwMCIgc3R5bGU9ImZvbnQtc2l6ZToyNXB4OyBmb250LWZhbWlseTpBcmlhbCIgeD0iMzEzLjYiIHk9IjE5NC4xMzMzMzMzMzMzMzMzMyI+TWFuYWdlbWVudCBOb2RlPC90ZXh0PjxyZWN0IGZpbGw9IiNmZjAwZmYiIGhlaWdodD0iMjEuMzMzMzMzMzMzMzMzMzMyIiBzdHJva2U9IiMwMDAwMDAiIHdpZHRoPSIyMS4zMzMzMzMzMzMzMzMzMzIiIHg9IjI4MS42IiB5PSIyMTcuNiIgLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBzdHlsZT0iZm9udC1zaXplOjI1cHg7IGZvbnQtZmFtaWx5OkFyaWFsIiB4PSIzMTMuNiIgeT0iMjM2Ljc5OTk5OTk5OTk5OTk4Ij5IZWFwIE5vZGU8L3RleHQ+PHJlY3QgZmlsbD0iI2ZmYTUwMCIgaGVpZ2h0PSIyMS4zMzMzMzMzMzMzMzMzMzIiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjIxLjMzMzMzMzMzMzMzMzMzMiIgeD0iMjgxLjYiIHk9IjI2MC4yNjY2NjY2NjY2NjY2NSIgLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBzdHlsZT0iZm9udC1zaXplOjI1cHg7IGZvbnQtZmFtaWx5OkFyaWFsIiB4PSIzMTMuNiIgeT0iMjc5LjQ2NjY2NjY2NjY2NjciPkRhdGE8L3RleHQ+PHJlY3QgZmlsbD0iI2ZmMDAwMCIgaGVpZ2h0PSIyMS4zMzMzMzMzMzMzMzMzMzIiIHN0cm9rZT0iIzAwMDAwMCIgd2lkdGg9IjIxLjMzMzMzMzMzMzMzMzMzMiIgeD0iMjgxLjYiIHk9IjMwMi45MzMzMzMzMzMzMzMzIiAvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIHN0eWxlPSJmb250LXNpemU6MjVweDsgZm9udC1mYW1pbHk6QXJpYWwiIHg9IjMxMy42IiB5PSIzMjIuMTMzMzMzMzMzMzMzMyI+TWlzYWxpZ25lZCBDaHVuayAvIEJ1ZzwvdGV4dD48L3N2Zz4="></p>
<p>The large rectangle is the heap managed by <code>heap_heap</code>. The upper row are the chunks created during the setup steps of the exploit and the lower row is the chunks created to leak the image address. In reality, those chunks overlap, but for better readability they are separated vertically.</p>
<p>One can see the misaligned management node in red which leads to the cyan node from the lower low overlapping with the last magenta node from the upper row.</p>
<h3 id="the-path-to-godt">The path to GO<s>D</s>T </h3>
<p>Through the leak of the image base address, we now are able forge pointers.</p>
<p>The first mission is to clean up the heap to avoid failing assertions in the heap management because we corrupted the second chunk's nodes. To do that we add a new chunk with a length greater than the distance where the heap is stored. Luckily the heap is stored after <code>mem</code>, the arena of the allocator. Therefore we allocate a string with 0x390 null-bytes as padding, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>mem</mtext><mo>+</mo><mn>0</mn><mtext>x</mtext><mn>200</mn></mrow><annotation encoding="application/x-tex">\text{mem} + 0\text x200</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">mem</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">200</span></span></span></span> as <code>heap.max</code> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> as <code>heap.num_nodes</code>. Effectively setting:</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code>heap <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>max <span class="token operator">=</span> mem <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>num_nodes <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>This means that the heap now contains one node and the node is located at an offset of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mtext>x</mtext><mn>200</mn></mrow><annotation encoding="application/x-tex">0\text x200</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">200</span></span></span></span> from the start of the arena. This is now in the region where the first chunk was previously allocated. This is also the reason we required to fill the first chunk with null-bytes or else further allocations would lead to failing assertions and segfaults.</p>
<p>The next step is to allocate a dummy chunk of some length <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><msub><mi>h</mi><mrow><mi>d</mi><mi>u</mi><mi>m</mi><mi>m</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">length_{dummy}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">mm</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> which we will edit later on. The value can be arbitrary, I chose to use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>500</mn></mrow><annotation encoding="application/x-tex">500</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">500</span></span></span></span>.</p>
<p>Now to the interesting part: Pivoting toward the position where we previously pointed a node in <code>heap</code> to. We do that by editing the dummy chunk with a size of<br>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><msub><mi>h</mi><mrow><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>t</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi><mo>−</mo><mi>c</mi><mi>u</mi><mi>r</mi><mi mathvariant="normal">_</mi><mi>t</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">(</mo><mi>m</mi><mi>e</mi><mi>m</mi><mo>+</mo><mn>0</mn><mtext>x</mtext><mn>200</mn><mo>−</mo><mn>0</mn><mtext>x</mtext><mn>28</mn><mo>⋅</mo><mn>2</mn><mo stretchy="false">)</mo><mo>−</mo><mo stretchy="false">(</mo><mi>m</mi><mi>e</mi><mi>m</mi><mo>+</mo><mn>0</mn><mtext>x</mtext><mn>1110</mn><mo>+</mo><mn>0</mn><mtext>x</mtext><mn>10</mn><mo>+</mo><mn>0</mn><mtext>x</mtext><mn>28</mn><mo>⋅</mo><mn>4</mn><mo>+</mo><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><msub><mi>h</mi><mrow><mi>d</mi><mi>u</mi><mi>m</mi><mi>m</mi><mi>y</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mn>0</mn><mtext>x</mtext><mn>1000</mn><mo>−</mo><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><msub><mi>h</mi><mrow><mi>d</mi><mi>u</mi><mi>m</mi><mi>m</mi><mi>y</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*} length_{pivot} &amp;= target - cur\_top \\ &amp;= (mem + 0\text x200 - 0\text x28 \cdot 2) - (mem + 0\text x1110 + 0\text x10 + 0\text x28 \cdot 4 + length_{dummy}) \\ &amp;= -0\text x1000 - length_{dummy}\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.5em;vertical-align:-2em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">200</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">28</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">1110</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">28</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">mm</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">1000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">mm</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>As we interpret the negative number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><msub><mi>h</mi><mrow><mi>p</mi><mi>i</mi><mi>v</mi><mi>o</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">length_{pivot}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> as an 64bit unsigned number, the resulting length is very large. But be aware to not write that many bytes, no today computer has Exabytes of RAM xD</p>
<p>To explain that formula a bit:</p>
<ol>
<li>We want to pivot from the current top chunk to the target address</li>
<li>The target address is 2 node chunks before our targeted fake chunk address, an actual management node will be placed there. Additionally, when editing the dummy again (to write the fake chunks), we need a management node before the heap node as well.</li>
<li><code>0x1110</code> is the offset of heap and <code>sizeof(Heap) = 0x10</code>.</li>
<li>The add of the dummy node allocated 3 nodes, i.e. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mtext>x</mtext><mn>28</mn><mo>⋅</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">0\text x28 \cdot 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">28</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>, and a data chunk with length <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mi>g</mi><mi>t</mi><msub><mi>h</mi><mrow><mi>d</mi><mi>u</mi><mi>m</mi><mi>m</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">length_{dummy}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">mm</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.</li>
<li>An additional management node is placed after the last allocation, i.e. another <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mtext>x</mtext><mn>28</mn></mrow><annotation encoding="application/x-tex">0\text x28</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mord text"><span class="mord">x</span></span><span class="mord">28</span></span></span></span>, and we do need the address of the next allocation.</li>
</ol>
<p>After pivoting, we can put the fake chunks into the memory using an edit. The following C-style initialization specifies the relevant fields, all the others can be chosen to fill with any value.</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> fakes_nodes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// management node 1</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0x28</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>data <span class="token operator">=</span> target <span class="token operator">+</span> <span class="token number">0x28</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// heap node</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>parent <span class="token operator">=</span> img_base <span class="token operator">+</span> <span class="token number">0x5138</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>data <span class="token operator">=</span> target <span class="token operator">+</span> <span class="token number">0x28</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// management node 2</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0x50000</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>exit@got<span class="token punctuation">[</span>plt<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>We need to edit again, to trigger the correct sorting of the heap, i.e. that our fake heap node is at the top of the heap. Also make sure to set a value lower than the value of the fake heap node's value during using the edit.</p>
<p>A delete puts the pointer into to <code>&amp;exit@got[plt]</code> into the free heap and with another edit, one can overwrite GOT with any pointer.</p>
<p>To trigger RCE, we just need to quit the program, which is conveniently offered by the challenge.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>